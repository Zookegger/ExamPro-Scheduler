// import
// import logo from "./logo.svg";
import { useState, useEffect } from "react";
import { check_server_health } from "./services/apiService";
import { io } from "socket.io-client";
import "./App.css";

// Real-time notification system (matching "ƒë·∫©y th√¥ng b√°o x√°c nh·∫≠n, nh·∫Øc l·ªãch thi")
function RealTimeNotifications() {
	const [notifications, set_notifications] = useState([]);
	const [is_connected, set_is_connected] = useState(false);

	useEffect(() => {
		// Mock real-time notifications - later implement WebSocket
		const mock_notifications = [
			{
				id: 1,
				type: "exam_reminder",
				message:
					"Nh·∫Øc nh·ªü: B·∫°n c√≥ k·ª≥ thi To√°n h·ªçc v√†o 10:00 AM ng√†y mai",
				timestamp: new Date().toLocaleString(),
				is_read: false,
			},
			{
				id: 2,
				type: "registration_confirmed",
				message: "X√°c nh·∫≠n: ƒêƒÉng k√Ω thi V·∫≠t l√Ω th√†nh c√¥ng",
				timestamp: new Date().toLocaleString(),
				is_read: false,
			},
			{
				id: 3,
				type: "schedule_conflict",
				message: "C·∫£nh b√°o: Ph√°t hi·ªán tr√πng l·∫∑p l·ªãch thi",
				timestamp: new Date().toLocaleString(),
				is_read: false,
			},
		];

		set_notifications(mock_notifications);
		set_is_connected(true); // Mock WebSocket connection
	}, []);

	const mark_as_read = (notification_id) => {
		set_notifications((prev) =>
			prev.map((notif) =>
				notif.id === notification_id
					? { ...notif, is_read: true }
					: notif
			)
		);
	};

	return (
		<div className="card mb-4">
			<div className="card-header d-flex justify-content-between align-items-center">
				<h5 className="mb-0">Th√¥ng B√°o Realtime</h5>
				<span
					className={`badge ${
						is_connected ? "badge-success" : "badge-danger"
					}`}
				>
					{is_connected ? "üü¢ K·∫øt n·ªëi" : "üî¥ M·∫•t k·∫øt n·ªëi"}
				</span>
			</div>
			<div className="card-body">
				{notifications.length > 0 ? (
					<div className="list-group">
						{notifications.map((notification) => (
							<div
								key={notification.id}
								className={`list-group-item ${
									!notification.is_read ? "bg-light" : ""
								}`}
							>
								<div className="d-flex justify-content-between">
									<div>
										<p className="mb-1">
											{notification.message}
										</p>
										<small className="text-muted">
											{notification.timestamp}
										</small>
									</div>
									{!notification.is_read && (
										<button
											className="btn btn-sm btn-outline-primary"
											onClick={() =>
												mark_as_read(notification.id)
											}
										>
											ƒê√£ ƒë·ªçc
										</button>
									)}
								</div>
							</div>
						))}
					</div>
				) : (
					<p className="text-muted">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</p>
				)}
			</div>
		</div>
	);
}

// Schedule optimization component (matching "t·ªëi ∆∞u h√≥a l·ªãch thi, tr√°nh tr√πng l·∫∑p")
function ScheduleOptimization() {
	const [optimization_status, set_optimization_status] = useState("idle");
	const [conflicts_found, set_conflicts_found] = useState([]);

	const run_optimization = () => {
		set_optimization_status("running");

		// Mock optimization process
		setTimeout(() => {
			const mock_conflicts = [
				{
					id: 1,
					conflict_type: "time_overlap",
					description:
						"Tr√πng l·∫∑p th·ªùi gian: To√°n h·ªçc v√† V·∫≠t l√Ω c√πng l√∫c 10:00 AM",
					severity: "high",
					suggested_solution: "D·ªùi V·∫≠t l√Ω sang 2:00 PM",
				},
				{
					id: 2,
					conflict_type: "room_conflict",
					description:
						"Tr√πng ph√≤ng: Ph√≤ng A1 ƒë∆∞·ª£c s·ª≠ d·ª•ng cho 2 k·ª≥ thi",
					severity: "medium",
					suggested_solution: "S·ª≠ d·ª•ng ph√≤ng B2 cho k·ª≥ thi th·ª© 2",
				},
			];

			set_conflicts_found(mock_conflicts);
			set_optimization_status("completed");
		}, 2000);
	};

	return (
		<div className="card mb-4">
			<div className="card-header">
				<h5 className="mb-0">T·ªëi ∆Øu H√≥a L·ªãch Thi</h5>
			</div>
			<div className="card-body">
				<div className="row">
					<div className="col-md-4">
						<button
							className="btn btn-primary btn-block"
							onClick={run_optimization}
							disabled={optimization_status === "running"}
						>
							{optimization_status === "running"
								? "ƒêang t·ªëi ∆∞u..."
								: "Ch·∫°y T·ªëi ∆Øu H√≥a"}
						</button>
					</div>
					<div className="col-md-8">
						{optimization_status === "running" && (
							<div className="progress">
								<div
									className="progress-bar progress-bar-striped progress-bar-animated"
									style={{ width: "100%" }}
								>
									ƒêang ki·ªÉm tra tr√πng l·∫∑p...
								</div>
							</div>
						)}

						{conflicts_found.length > 0 &&
							optimization_status === "completed" && (
								<div className="mt-3">
									<h6>
										Ph√°t hi·ªán {conflicts_found.length} xung
										ƒë·ªôt:
									</h6>
									{conflicts_found.map((conflict) => (
										<div
											key={conflict.id}
											className="alert alert-warning"
										>
											<strong>
												{conflict.description}
											</strong>
											<br />
											<small>
												ƒê·ªÅ xu·∫•t:{" "}
												{conflict.suggested_solution}
											</small>
										</div>
									))}
								</div>
							)}
					</div>
				</div>
			</div>
		</div>
	);
}

// Real-time exam monitoring (matching "ki·ªÉm tra th·ªùi gian th·ª±c")
function RealTimeExamMonitoring() {
	const [active_exams, set_active_exams] = useState([]);
	const [monitoring_status, set_monitoring_status] = useState("active");

	useEffect(() => {
		// Mock real-time exam monitoring
		const mock_active_exams = [
			{
				id: 1,
				subject: "To√°n h·ªçc",
				start_time: "10:00 AM",
				end_time: "12:00 PM",
				room: "Ph√≤ng A1",
				students_present: 23,
				total_students: 25,
				proctor: "Gi√°o vi√™n Nguy·ªÖn",
				status: "in_progress",
			},
			{
				id: 2,
				subject: "Ti·∫øng Anh",
				start_time: "2:00 PM",
				end_time: "4:00 PM",
				room: "Ph√≤ng B2",
				students_present: 18,
				total_students: 20,
				proctor: "Gi√°o vi√™n Tr·∫ßn",
				status: "starting_soon",
			},
		];

		set_active_exams(mock_active_exams);

		// Mock real-time updates
		const interval = setInterval(() => {
			set_active_exams((prev) =>
				prev.map((exam) => ({
					...exam,
					students_present: Math.min(
						exam.students_present + Math.floor(Math.random() * 2),
						exam.total_students
					),
				}))
			);
		}, 3000);

		return () => clearInterval(interval);
	}, []);

	const get_status_badge = (status) => {
		switch (status) {
			case "in_progress":
				return (
					<span className="badge badge-success">ƒêang di·ªÖn ra</span>
				);
			case "starting_soon":
				return <span className="badge badge-warning">S·∫Øp b·∫Øt ƒë·∫ßu</span>;
			case "completed":
				return (
					<span className="badge badge-secondary">Ho√†n th√†nh</span>
				);
			default:
				return (
					<span className="badge badge-secondary">
						Kh√¥ng x√°c ƒë·ªãnh
					</span>
				);
		}
	};

	return (
		<div className="card mb-4">
			<div className="card-header d-flex justify-content-between align-items-center">
				<h5 className="mb-0">Ki·ªÉm Tra K·ª≥ Thi Realtime</h5>
				<span
					className={`badge ${
						monitoring_status === "active"
							? "badge-success"
							: "badge-danger"
					}`}
				>
					{monitoring_status === "active"
						? "üü¢ ƒêang gi√°m s√°t"
						: "üî¥ T·∫°m d·ª´ng"}
				</span>
			</div>
			<div className="card-body">
				{active_exams.length > 0 ? (
					<div className="table-responsive">
						<table className="table table-sm">
							<thead>
								<tr>
									<th>M√¥n thi</th>
									<th>Th·ªùi gian</th>
									<th>Ph√≤ng</th>
									<th>H·ªçc sinh</th>
									<th>Gi√°m th·ªã</th>
									<th>Tr·∫°ng th√°i</th>
								</tr>
							</thead>
							<tbody>
								{active_exams.map((exam) => (
									<tr key={exam.id}>
										<td>{exam.subject}</td>
										<td>
											{exam.start_time} - {exam.end_time}
										</td>
										<td>{exam.room}</td>
										<td>
											<span
												className={`badge ${
													exam.students_present ===
													exam.total_students
														? "badge-success"
														: "badge-warning"
												}`}
											>
												{exam.students_present}/
												{exam.total_students}
											</span>
										</td>
										<td>{exam.proctor}</td>
										<td>{get_status_badge(exam.status)}</td>
									</tr>
								))}
							</tbody>
						</table>
					</div>
				) : (
					<p className="text-muted">
						Hi·ªán t·∫°i kh√¥ng c√≥ k·ª≥ thi n√†o ƒëang di·ªÖn ra
					</p>
				)}
			</div>
		</div>
	);
}

// Updated role-based stats to match Vietnamese context
function AdminDashboardStats() {
	const [admin_stats, set_admin_stats] = useState({
		total_exam_sessions: 0,
		registered_students: 0,
		active_teachers: 0,
		schedule_conflicts: 0,
		pending_registrations: 0,
	});

	useEffect(() => {
		set_admin_stats({
			total_exam_sessions: 45,
			registered_students: 250,
			active_teachers: 15,
			schedule_conflicts: 3,
			pending_registrations: 8,
		});
	}, []);

	return (
		<div className="row mb-4">
			<div className="col-md-2">
				<div className="card text-center">
					<div className="card-body">
						<h6 className="card-title">T·ªïng K·ª≥ Thi</h6>
						<h3 className="text-primary">
							{admin_stats.total_exam_sessions}
						</h3>
					</div>
				</div>
			</div>
			<div className="col-md-3">
				<div className="card text-center">
					<div className="card-body">
						<h6 className="card-title">H·ªçc Sinh ƒêƒÉng K√Ω</h6>
						<h3 className="text-success">
							{admin_stats.registered_students}
						</h3>
					</div>
				</div>
			</div>
			<div className="col-md-2">
				<div className="card text-center">
					<div className="card-body">
						<h6 className="card-title">Gi√°o Vi√™n</h6>
						<h3 className="text-info">
							{admin_stats.active_teachers}
						</h3>
					</div>
				</div>
			</div>
			<div className="col-md-3">
				<div className="card text-center">
					<div className="card-body">
						<h6 className="card-title">Xung ƒê·ªôt L·ªãch</h6>
						<h3 className="text-warning">
							{admin_stats.schedule_conflicts}
						</h3>
					</div>
				</div>
			</div>
			<div className="col-md-2">
				<div className="card text-center">
					<div className="card-body">
						<h6 className="card-title">Ch·ªù Duy·ªát</h6>
						<h3 className="text-danger">
							{admin_stats.pending_registrations}
						</h3>
					</div>
				</div>
			</div>
		</div>
	);
}

// Component to check if server is running
/**
 * ServerHealthCheck Component
 * 
 * Real-time health monitoring for the exam management system server.
 * Uses WebSocket for live connection status and provides role-based error messages.
 * 
 * @param {Object} props - Component properties
 * @param {string} props.current_user_role - Current user role (student/teacher/admin)
 */
function ServerHealthCheck({ current_user_role }) {
    // ============================================
    // STATE MANAGEMENT
    // ============================================
    const [server_status, set_server_status] = useState("ƒêang ki·ªÉm tra...");
    const [is_loading, set_is_loading] = useState(true);
    const [is_connected, set_is_connected] = useState(false);
    const [responses, set_responses] = useState([]);

    // ============================================
    // ERROR MESSAGE HELPERS
    // ============================================
    
    /**
     * Generate role-appropriate error messages for general errors
     * Admin sees technical details, others see user-friendly messages
     */
    const get_error_message_for_role = (error, user_role) => {
        switch (user_role) {
            case "admin":
                return `Error ${error.code}: ${error.message}`;
            case "teacher":
            case "student":
                return `‚ùå L·ªói k·∫øt n·ªëi (M√£ l·ªói: ${error.code || "UNKNOWN"})`;
            default:
                return "‚ùå L·ªói h·ªá th·ªëng";
        }
    };

    /**
     * Generate role-appropriate error messages for connection failures
     * Different levels of detail based on user role
     */
    const get_connection_error_message = (error, user_role) => {
        switch (user_role) {
            case "admin":
                return `‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi server: ${error.message}`;
            case "teacher":
            case "student":
                return `‚ùå M√°y ch·ªß kh√¥ng ph·∫£n h·ªìi (M√£ l·ªói: CONN_REFUSED)`;
            default:
                return "‚ùå L·ªói k·∫øt n·ªëi h·ªá th·ªëng";
        }
    };

    /**
     * Create standardized error response object
     * Admin gets full error details, others get limited info for security
     */
    const create_error_response = (error, user_role) => {
        const base_response = {
            id: Date.now(),
            timestamp: new Date().toISOString(),
            server_status: "error",
            received_at: new Date().toLocaleString(),
        };

        if (user_role === "admin") {
            return {
                ...base_response,
                connection_id: "unknown",
                error_message: error.message,
                error_stack: error.stack,
            };
        } else {
            return {
                ...base_response,
                connection_id: "hidden",
                error_code: error.code || "CONN_ERROR",
            };
        }
    };

    // ============================================
    // RESPONSE VALIDATION HELPERS
    // ============================================
    
    /**
     * Validate server response data
     * Returns true if valid, false otherwise
     */
    const validate_server_response = (server_data) => {
        if (!server_data) {
            console.warn("‚ö†Ô∏è Received empty response from server");
            set_server_status("‚ö†Ô∏è Ph·∫£n h·ªìi m√°y ch·ªß kh√¥ng ƒë·∫ßy ƒë·ªß");
            return false;
        }

        if (!server_data.server_status) {
            console.warn("Health pong missing server_status field");
            set_server_status("‚ö†Ô∏è Ph·∫£n h·ªìi m√°y ch·ªß kh√¥ng ƒë·∫ßy ƒë·ªß");
            return false;
        }

        return true;
    };

    /**
     * Process valid server response
     * Updates UI status and response history
     */
    const process_server_response = (server_data) => {
        // Update status display based on server health
        if (server_data.server_status === "healthy") {
            set_server_status("‚úÖ M√°y ch·ªß ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng");
        } else {
            set_server_status("‚ùå M√°y ch·ªß kh√¥ng ph·∫£n h·ªìi");
        }

        // Create response record for history
        const new_response = {
            id: Date.now(),
            timestamp: server_data.timestamp,
            server_status: server_data.server_status,
            connection_id: server_data.connection_id,
            received_at: new Date().toLocaleString(),
        };

        // Keep only last 5 responses
        set_responses((prev) => [new_response, ...prev].slice(0, 5));
    };

    // ============================================
    // WEBSOCKET CONNECTION EFFECT
    // ============================================
    useEffect(() => {
        console.log(`üîå Initializing health check for role: ${current_user_role}`);
        
        // Initialize WebSocket connection to server
		const socket_url = process.env.REACT_APP_WS_URL || 'http://localhost:5000';
        const socket = io(socket_url);
        let ping_interval = null;

        // ========== CONNECTION HANDLERS ==========
        
        socket.on("connect", () => {
            console.log("WebSocket connected for health check");
            console.log(`üîå Client connected: ${socket.id}`);
            console.log('üìù Note: Each browser tab creates a separate connection');
    
            set_is_loading(false);
            set_is_connected(true);

            // Send initial health ping
            socket.emit("health_ping");

            ping_interval = setInterval(() => {
                if (socket.connected) {
                    console.log("Sending health ping...");
                    socket.emit("health_ping");
                }
            }, 15000);
        });

        socket.on("disconnect", () => {
            console.log("WebSocket disconnected");
            
            if (!socket.disconnected) {
                console.error(`Failed to close connection!`);
            }
        });

        // ========== RESPONSE HANDLERS ==========
        
        socket.on("health_pong", (server_data) => {
            try {
                console.log("Received health response: ", server_data);

                // Validate response data
                if (!validate_server_response(server_data)) {
                    return; // Early exit if invalid
                }

                // Process valid response
                process_server_response(server_data);

            } catch (error) {
                console.error("Error handling health pong: ", error);

                // Generate role-appropriate error message
                const error_message = get_error_message_for_role(
                    error,
                    current_user_role
                );
                set_server_status(error_message);

                // Add error to response history
                const error_response = create_error_response(
                    error,
                    current_user_role
                );
                set_responses((prev) => [error_response, ...prev].slice(0, 5));
            }
        });

        // ========== ERROR HANDLERS ==========
        
        socket.on("connect_error", (error) => {
            console.error(`WebSocket connection failed: ${error}`);
            set_is_connected(false);
            set_is_loading(false);

            // Set role-appropriate error message
            set_server_status(
                get_connection_error_message(error, current_user_role)
            );
        });

        // ========== CLEANUP ==========
        
        return () => {
            console.log("üßπ Cleaning up health check...");

            // Clear ping interval if it exists
            if (ping_interval) {
                console.log("Clearing ping interval");
                clearInterval(ping_interval);
                ping_interval = null;
            }

            // Disconnect WebSocket
            if (socket && socket.connected) {
                console.log("Disconnecting WebSocket");
                socket.disconnect();
            }
            console.log("üîå Health check WebSocket cleaned up ‚úÖ");
        };
    }, [current_user_role]);

    // ============================================
    // RENDER
    // ============================================
    return (
        <div className="card mb-4">
            <div className="card-header d-flex justify-content-between align-items-center">
                <h5 className="mb-0">Tr·∫°ng Th√°i H·ªá Th·ªëng</h5>
                <span
                    className={`badge ${
                        is_connected ? "badge-success" : "badge-danger"
                    }`}
                >
                    {is_connected ? "üü¢ K·∫øt n·ªëi" : "üî¥ M·∫•t k·∫øt n·ªëi"}
                </span>
            </div>
            <div className="card-body">
                {is_loading ? (
                    <div className="d-flex align-items-center">
                        <div className="spinner-border spinner-border-sm me-2" role="status">
                            <span className="visually-hidden">Loading...</span>
                        </div>
                        <span>ƒêang ki·ªÉm tra m√°y ch·ªß...</span>
                    </div>
                ) : (
					<>
                    <p className="mb-0">{server_status}</p>
					
					{/* Show response history */}
					{responses.length > 0 && (
						<div className="mt-3">
							<h6>L·ªãch s·ª≠ ki·ªÉm tra g·∫ßn ƒë√¢y:</h6>
							<div className="table-responsive">
								<table className="table table-sm">
									<thead>
										<tr>
											<th>Th·ªùi gian</th>
											<th>Tr·∫°ng th√°i</th>
											{current_user_role === "admin" && <th>Connection ID</th>}
										</tr>
									</thead>
									<tbody>
										{responses.map((response) => (
											<tr key={response.id}>
												<td>{response.received_at}</td>
												<td>
													<span className={`badge ${
														response.server_status === "healthy" 
															? "badge-success" 
															: "badge-danger"
													}`}>
														{response.server_status === "healthy" 
															? "‚úÖ Ho·∫°t ƒë·ªông" 
															: "‚ùå L·ªói"}
													</span>
												</td>
												{current_user_role === "admin" && (
													<td><small className="text-muted">{response.connection_id}</small></td>
												)}
											</tr>
										))}
									</tbody>
								</table>
							</div>
						</div>
					)}
					</>
                )}
            </div>
        </div>
    );
}

function App() {
	const [current_user_role, set_current_user_role] = useState("student");

	return (
		<div className="App">
			<header className="App-header bg-primary text-white py-3">
				<div className="container">
					<h1 className="mb-0">
						H·ªá Th·ªëng Qu·∫£n L√Ω ƒêƒÉng K√Ω & X·∫øp L·ªãch Thi
					</h1>
					<small>
						Ki·ªÉm tra th·ªùi gian th·ª±c - WebSocket + Dashboard
					</small>
				</div>
			</header>
			<main className="container my-4">
				<div className="row">
					<div className="col-12">
						<ServerHealthCheck
							current_user_role={current_user_role}
						/>

						{/* Role selector */}
						<div className="card mb-4">
							<div className="card-header">
								<h5 className="mb-0">
									Vai tr√≤:{" "}
									{current_user_role === "student"
										? "H·ªçc sinh"
										: current_user_role === "teacher"
										? "Gi√°o vi√™n"
										: "Qu·∫£n tr·ªã vi√™n"}
								</h5>
							</div>
							<div className="card-body">
								<div className="btn-group" role="group">
									<button
										className={`btn ${
											current_user_role === "student"
												? "btn-primary"
												: "btn-outline-primary"
										}`}
										onClick={() =>
											set_current_user_role("student")
										}
									>
										üë®‚Äçüéì H·ªçc sinh
									</button>
									<button
										className={`btn ${
											current_user_role === "teacher"
												? "btn-success"
												: "btn-outline-success"
										}`}
										onClick={() =>
											set_current_user_role("teacher")
										}
									>
										üë®‚Äçüè´ Gi√°o vi√™n
									</button>
									<button
										className={`btn ${
											current_user_role === "admin"
												? "btn-danger"
												: "btn-outline-danger"
										}`}
										onClick={() =>
											set_current_user_role("admin")
										}
									>
										üë®‚Äçüíº Qu·∫£n tr·ªã vi√™n
									</button>
								</div>
							</div>
						</div>

						{/* Real-time features matching project description */}
						<RealTimeNotifications />
						<ScheduleOptimization />
						<RealTimeExamMonitoring />
						<AdminDashboardStats />
					</div>
				</div>
			</main>
			<footer className="bg-light py-3 mt-auto">
				<div className="container text-center">
					<p className="mb-0 text-muted">
						¬© 2024 H·ªá Th·ªëng Qu·∫£n L√Ω Thi - D√†nh cho tr∆∞·ªùng h·ªçc v√†
						trung t√¢m ƒë√†o t·∫°o
					</p>
				</div>
			</footer>
		</div>
	);
}

export default App;